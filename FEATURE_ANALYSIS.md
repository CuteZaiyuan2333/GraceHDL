# GraceHDL编译器功能需求分析

## 当前已实现的功能 ✅

### 基础语法
- [x] 模块定义 (`module name:`)
- [x] 输入输出声明 (`input()`, `output()`)
- [x] 寄存器声明 (`register()`)
- [x] 时序逻辑 (`run (clk.posedge):`)
- [x] 组合逻辑 (`always:`)
- [x] 新数值格式 (`(value, base, width)`)

### 数据类型
- [x] wire类型
- [x] reg类型
- [x] 位宽声明 (`reg(7:0)`)
- [x] 多种进制数值 (二进制、十进制、十六进制、八进制)

### 控制结构
- [x] if-else语句
- [x] 基本表达式运算
- [x] 赋值语句

### 代码生成
- [x] 标准Verilog输出
- [x] 正确的always块生成
- [x] 数值格式转换

## 需要补充的核心功能 🔧

### 1. 语法增强
- [ ] **注释支持** - 单行注释 (`//`) 和多行注释 (`/* */`)
- [ ] **缩进处理** - 正确处理Python风格的缩进
- [ ] **多行语句** - 支持跨行的复杂语句
- [x] **case语句** - 完整的case-when-default结构
- [ ] **for循环** - 用于生成重复逻辑
- [ ] **函数定义** - 支持用户自定义函数

### 2. 高级数据类型
- [x] **数组支持** - `reg(7:0) memory[255:0]` (数组声明、索引访问、索引赋值)
- [ ] **结构体** - 类似SystemVerilog的struct
- [ ] **枚举类型** - 状态机的状态定义
- [ ] **参数化模块** - 支持参数传递

### 3. 模块化设计
- [x] **模块实例化** - 在一个模块中使用另一个模块
- [ ] **端口连接** - 支持按名称和按位置连接
- [ ] **层次化设计** - 支持多层模块嵌套
- [ ] **接口定义** - 标准化的接口声明

### 4. 时序控制
- [ ] **时钟域** - 多时钟设计支持
- [ ] **复位策略** - 同步/异步复位
- [ ] **时序约束** - setup/hold时间
- [ ] **延迟控制** - `#delay` 语法

### 5. 验证支持
- [ ] **断言** - assert语句
- [ ] **测试台生成** - 自动生成testbench
- [ ] **波形输出** - VCD文件生成
- [ ] **覆盖率分析** - 代码覆盖率统计

### 6. 错误处理
- [ ] **语法错误定位** - 精确的错误行号和列号
- [ ] **语义检查** - 类型检查、未定义变量检查
- [ ] **警告系统** - 未使用变量、时序问题等
- [ ] **建议系统** - 代码优化建议

## 教学优先级功能 🎓

### 高优先级 (必须实现)
1. **注释支持** - 教学代码需要大量注释
2. **case语句** ✅ - 状态机设计必需
3. **模块实例化** - 层次化设计基础
4. **数组支持** - 存储器设计需要
5. **错误定位** - 学生调试必需

### 中优先级 (建议实现)
1. **for循环** - 简化重复代码
2. **枚举类型** - 提高代码可读性
3. **参数化模块** - 可重用设计
4. **测试台生成** - 验证支持
5. **时钟域处理** - 实际设计需要

### 低优先级 (可选实现)
1. **结构体** - 高级特性
2. **断言** - 高级验证
3. **时序约束** - FPGA实现相关
4. **覆盖率分析** - 高级验证特性

## 当前问题分析 🐛

### 1. 注释处理问题
- **问题**: 词法分析器定义了注释但语法分析器无法正确处理
- **影响**: 无法在代码中添加注释，严重影响教学使用
- **解决方案**: 修改语法分析器，正确忽略注释标记

### 2. 缩进处理不完整
- **问题**: 定义了INDENT/DEDENT但处理逻辑不完整
- **影响**: 复杂的嵌套结构无法正确解析
- **解决方案**: 完善缩进处理逻辑

### 3. case语句 ✅ 已实现
- **状态**: 已完成case语句的完整实现
- **功能**: 支持case-when-default结构、多分支条件判断、嵌套语句
- **测试**: 通过状态机测试验证

### 4. 错误信息不够详细
- **问题**: 错误信息只显示标记类型，不显示具体位置
- **影响**: 学生难以定位和修复错误
- **解决方案**: 改进错误报告系统

## 实现建议 💡

### 阶段1: 基础完善 (1-2周)
1. 修复注释处理
2. 完善缩进逻辑
3. ✅ case语句生成 (已完成)
4. 改进错误报告

### 阶段2: 功能扩展 (2-3周)
1. 添加模块实例化
2. 实现数组支持
3. 添加for循环
4. 实现枚举类型

### 阶段3: 高级特性 (3-4周)
1. 参数化模块
2. 测试台生成
3. 多时钟域支持
4. 验证功能

## 测试用例需求 📝

### 基础测试
- [ ] 带注释的简单模块
- [ ] 复杂嵌套的if-else
- [ ] case语句状态机
- [ ] 数组操作

### 进阶测试
- [ ] 模块实例化
- [ ] 参数化设计
- [ ] 多时钟域
- [ ] 完整的CPU设计

### 错误测试
- [ ] 语法错误定位
- [ ] 类型错误检查
- [ ] 未定义变量检查
- [ ] 时序问题检查